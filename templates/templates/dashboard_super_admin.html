{% extends "base.html" %}

{% block title %}Super Admin Dashboard - SmartGardenHub{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.6"></script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}

{% block content %}
<div x-data="superAdminDashboard()" class="flex h-screen bg-gray-50">
    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-lg border-r border-gray-200" :class="{ '-translate-x-full': !sidebarOpen }" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="-translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="-translate-x-full">
        
        <!-- Sidebar Header -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-gradient-to-r from-red-600 to-pink-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-crown text-white text-lg"></i>
                </div>
                <div class="ml-3">
                    <h2 class="text-lg font-semibold text-gray-900">Super Admin</h2>
                    <p class="text-sm text-red-600 font-semibold">System Control</p>
                    <p class="text-xs text-gray-500">Welcome, {{ user.firstName }} {{ user.lastName }}!</p>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="mt-6">
            <div class="px-3 space-y-1">
                <template x-for="item in menuItems" :key="item.id">
                    <button 
                        @click="activeSection = item.id"
                        :class="{
                            'bg-red-50 border-r-2 border-red-500 text-red-700': activeSection === item.id,
                            'text-gray-600 hover:bg-gray-50 hover:text-gray-900': activeSection !== item.id
                        }"
                        class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-l-md transition-colors duration-200">
                        <i :class="item.icon" class="mr-3 text-lg"></i>
                        <span x-text="item.title"></span>
                    </button>
                </template>
            </div>
        </nav>

        <!-- Logout Button -->
        <div class="absolute bottom-4 left-4 right-4">
            <button @click="logout()" 
                    class="w-full flex items-center px-3 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded-md transition-colors duration-200">
                <i class="fas fa-sign-out-alt mr-3"></i>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button @click="sidebarOpen = !sidebarOpen" class="lg:hidden mr-4">
                        <i class="fas fa-bars text-gray-600"></i>
                    </button>
                    <h1 class="text-2xl font-bold text-gray-900" x-text="currentTitle"></h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        <span class="font-medium">SMS Balance:</span>
                        <span class="text-green-600 font-bold" x-text="user.smsCount || 0"></span>
                    </div>
                    <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-crown text-white text-sm"></i>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-6">
            <!-- Dashboard Overview -->
            <div x-show="activeSection === 'dashboard'" x-cloak>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <!-- Total Teachers -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chalkboard-teacher text-blue-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Teachers</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.totalTeachers || 0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Total Students -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user-graduate text-green-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Students</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.totalStudents || 0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Total Batches -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-layer-group text-purple-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Batches</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.totalBatches || 0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- System SMS Balance -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-sms text-red-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">System SMS</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="user.smsCount || 0"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button @click="activeSection = 'sms-management'" 
                                class="flex items-center p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                            <i class="fas fa-sms text-blue-600 text-xl mr-3"></i>
                            <span class="font-medium text-blue-700">Manage SMS Credits</span>
                        </button>
                        <button @click="viewAllTeachers()" 
                                class="flex items-center p-4 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
                            <i class="fas fa-users text-green-600 text-xl mr-3"></i>
                            <span class="font-medium text-green-700">View All Teachers</span>
                        </button>
                        <button @click="viewSystemStats()" 
                                class="flex items-center p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors">
                            <i class="fas fa-chart-bar text-purple-600 text-xl mr-3"></i>
                            <span class="font-medium text-purple-700">System Statistics</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- SMS Management -->
            <div x-show="activeSection === 'sms-management'" x-cloak>
                {% include 'partials/super_admin_sms.html' %}
            </div>
        </main>
    </div>
</div>

<script>
function superAdminDashboard() {
    return {
        sidebarOpen: true,
        activeSection: 'dashboard',
        user: {{ user | tojson | safe }},
        stats: {
            totalTeachers: 0,
            totalStudents: 0,
            totalBatches: 0
        },
        
        // SMS Management properties
        teachers: [],
        selectedTeacher: '',
        creditsToAdd: '',
        adding: false,
        smsStats: {
            totalCreditsDistributed: 0,
            totalCreditsUsed: 0,
            activeTeachers: 0
        },
        
        menuItems: [
            { id: 'dashboard', title: 'Dashboard', icon: 'fas fa-tachometer-alt' },
            { id: 'sms-management', title: 'SMS Management', icon: 'fas fa-sms' }
        ],

        get currentTitle() {
            const item = this.menuItems.find(item => item.id === this.activeSection);
            return item ? item.title : 'Super Admin Dashboard';
        },

        init() {
            this.loadStats();
            this.loadTeachers();
            this.loadSMSStats();
        },

        async loadStats() {
            try {
                const response = await fetch('/api/dashboard/stats', {
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    this.stats = await response.json();
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        },

        async loadTeachers() {
            try {
                const response = await fetch('/api/users/teachers', {
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const data = await response.json();
                    this.teachers = data.data.teachers || [];
                }
            } catch (error) {
                console.error('Failed to load teachers:', error);
                this.teachers = [];
            }
        },

        async loadSMSStats() {
            try {
                const response = await fetch('/api/sms/stats', {
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const data = await response.json();
                    this.smsStats = data.data || this.smsStats;
                }
            } catch (error) {
                console.error('Failed to load SMS stats:', error);
            }
        },

        async addSMSCredits() {
            if (!this.selectedTeacher || !this.creditsToAdd) return;
            
            this.adding = true;
            try {
                const response = await fetch('/api/sms/add-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        teacher_id: this.selectedTeacher,
                        credits: parseInt(this.creditsToAdd),
                        memo: 'Added by Super Admin'
                    })
                });

                if (response.ok) {
                    alert(`Successfully added ${this.creditsToAdd} SMS credits!`);
                    this.selectedTeacher = '';
                    this.creditsToAdd = '';
                    await this.loadTeachers();
                    await this.loadSMSStats();
                } else {
                    const error = await response.json();
                    alert(`Failed to add credits: ${error.message}`);
                }
            } catch (error) {
                console.error('Failed to add SMS credits:', error);
                alert('Failed to add SMS credits. Please try again.');
            } finally {
                this.adding = false;
            }
        },

        async quickAddCredits(teacherId, credits) {
            try {
                const response = await fetch('/api/sms/add-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        teacher_id: teacherId,
                        credits: credits,
                        memo: `Quick add ${credits} credits by Super Admin`
                    })
                });

                if (response.ok) {
                    alert(`Successfully added ${credits} SMS credits!`);
                    await this.loadTeachers();
                    await this.loadSMSStats();
                } else {
                    const error = await response.json();
                    alert(`Failed to add credits: ${error.message}`);
                }
            } catch (error) {
                console.error('Failed to add SMS credits:', error);
                alert('Failed to add SMS credits. Please try again.');
            }
        },

        formatDate(dateString) {
            if (!dateString) return 'Never';
            return new Date(dateString).toLocaleDateString();
        },

        viewAllTeachers() {
            this.activeSection = 'sms-management';
        },

        viewSystemStats() {
            // TODO: Implement system statistics
            alert('System statistics coming soon!');
        },

        async logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/login';
            }
        }
    };
}
</script>
{% endblock %}