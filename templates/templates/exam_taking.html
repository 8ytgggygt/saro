{% extends "base.html" %}

{% block title %}Online Exam - SmartGardenHub{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Exam Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div>
                    <h1 id="examTitle" class="text-xl font-semibold text-gray-900">Loading Exam...</h1>
                    <p id="examSubject" class="text-sm text-gray-600">Subject</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Time Remaining</div>
                        <div id="timer" class="text-lg font-bold text-red-600">00:00:00</div>
                    </div>
                    <button id="submitExam" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium">
                        Submit Exam
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Exam Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">Loading exam questions...</p>
        </div>

        <!-- Exam Form -->
        <form id="examForm" class="hidden">
            <div id="questionsContainer">
                <!-- Questions will be loaded here -->
            </div>

            <!-- Navigation -->
            <div class="mt-8 flex justify-between items-center bg-white p-4 rounded-lg shadow">
                <button type="button" id="prevQuestion" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-left mr-1"></i> Previous
                </button>
                
                <div class="flex space-x-2" id="questionNumbers">
                    <!-- Question numbers will be generated here -->
                </div>
                
                <button type="button" id="nextQuestion" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next <i class="fas fa-chevron-right ml-1"></i>
                </button>
            </div>
        </form>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <i class="fas fa-exclamation-triangle text-3xl text-red-400 mb-4"></i>
            <p class="text-red-600 mb-4">Failed to load exam</p>
            <button onclick="window.location.reload()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                Try Again
            </button>
        </div>
    </div>

    <!-- Submit Confirmation Modal -->
    <div id="submitModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mt-4">Submit Exam?</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Are you sure you want to submit your exam? You won't be able to make changes after submission.
                    </p>
                    <div class="mt-4">
                        <div class="text-sm text-gray-600">
                            <span id="answeredCount">0</span> of <span id="totalQuestions">0</span> questions answered
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-4">
                    <button id="confirmSubmit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 flex-1">
                        Yes, Submit
                    </button>
                    <button id="cancelSubmit" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 flex-1">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let examData = null;
    let currentQuestionIndex = 0;
    let answers = {};
    let timeRemaining = 0;
    let timerInterval = null;
    let examId = null;

    // Get exam ID from URL
    const pathParts = window.location.pathname.split('/');
    examId = pathParts[pathParts.length - 1];

    // DOM elements
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const examForm = document.getElementById('examForm');
    const questionsContainer = document.getElementById('questionsContainer');
    const prevButton = document.getElementById('prevQuestion');
    const nextButton = document.getElementById('nextQuestion');
    const submitButton = document.getElementById('submitExam');
    const submitModal = document.getElementById('submitModal');
    const confirmSubmit = document.getElementById('confirmSubmit');
    const cancelSubmit = document.getElementById('cancelSubmit');
    const timer = document.getElementById('timer');

    // Initialize exam
    loadExam();

    async function loadExam() {
        try {
            const response = await fetch(`/api/exams/${examId}/start`);
            if (response.ok) {
                examData = await response.json();
                initializeExam();
            } else {
                showError();
            }
        } catch (error) {
            console.error('Error loading exam:', error);
            showError();
        }
    }

    function showError() {
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
    }

    function initializeExam() {
        // Set exam info
        document.getElementById('examTitle').textContent = examData.title;
        document.getElementById('examSubject').textContent = examData.subject;
        
        // Set timer
        timeRemaining = examData.duration * 60; // Convert minutes to seconds
        startTimer();

        // Generate questions
        generateQuestions();
        generateQuestionNumbers();
        
        // Show exam form
        loadingState.classList.add('hidden');
        examForm.classList.remove('hidden');
        
        // Show first question
        showQuestion(0);
        
        // Auto-save answers periodically
        setInterval(autoSave, 30000); // Save every 30 seconds
    }

    function generateQuestions() {
        examData.questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item hidden bg-white p-6 rounded-lg shadow mb-6';
            questionDiv.id = `question-${index}`;
            
            questionDiv.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-medium text-gray-900">Question ${index + 1}</h3>
                        <span class="text-sm text-gray-500">${question.marks} marks</span>
                    </div>
                    <div class="text-gray-700 mb-4">${question.question}</div>
                </div>
                
                <div class="space-y-3">
                    ${question.options.map((option, optionIndex) => `
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="question_${question.id}" value="${optionIndex}" 
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="ml-3 text-gray-700">${option}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            
            questionsContainer.appendChild(questionDiv);
        });
    }

    function generateQuestionNumbers() {
        const questionNumbers = document.getElementById('questionNumbers');
        questionNumbers.innerHTML = '';
        
        examData.questions.forEach((_, index) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'question-num w-8 h-8 rounded-full border-2 text-sm font-medium';
            button.textContent = index + 1;
            button.onclick = () => showQuestion(index);
            questionNumbers.appendChild(button);
        });
        
        updateQuestionNumbers();
    }

    function showQuestion(index) {
        // Hide all questions
        document.querySelectorAll('.question-item').forEach(q => q.classList.add('hidden'));
        
        // Show current question
        const currentQuestion = document.getElementById(`question-${index}`);
        if (currentQuestion) {
            currentQuestion.classList.remove('hidden');
            currentQuestionIndex = index;
            
            // Update navigation buttons
            prevButton.disabled = index === 0;
            nextButton.disabled = index === examData.questions.length - 1;
            
            // Update question numbers
            updateQuestionNumbers();
        }
    }

    function updateQuestionNumbers() {
        const buttons = document.querySelectorAll('.question-num');
        buttons.forEach((button, index) => {
            button.classList.remove('bg-indigo-600', 'text-white', 'bg-green-500', 'border-indigo-600', 'border-green-500', 'text-indigo-600', 'text-green-500', 'border-gray-300', 'text-gray-500');
            
            if (index === currentQuestionIndex) {
                // Current question
                button.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
            } else if (answers[examData.questions[index].id]) {
                // Answered question
                button.classList.add('bg-green-500', 'text-white', 'border-green-500');
            } else {
                // Unanswered question
                button.classList.add('border-gray-300', 'text-gray-500');
            }
        });
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                autoSubmitExam();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const hours = Math.floor(timeRemaining / 3600);
        const minutes = Math.floor((timeRemaining % 3600) / 60);
        const seconds = timeRemaining % 60;
        
        timer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color based on time remaining
        if (timeRemaining <= 300) { // 5 minutes
            timer.className = 'text-lg font-bold text-red-600';
        } else if (timeRemaining <= 600) { // 10 minutes
            timer.className = 'text-lg font-bold text-yellow-600';
        } else {
            timer.className = 'text-lg font-bold text-green-600';
        }
    }

    function collectAnswers() {
        examData.questions.forEach(question => {
            const selectedOption = document.querySelector(`input[name="question_${question.id}"]:checked`);
            if (selectedOption) {
                answers[question.id] = parseInt(selectedOption.value);
            }
        });
    }

    async function autoSave() {
        collectAnswers();
        try {
            await fetch(`/api/exams/${examId}/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ answers })
            });
        } catch (error) {
            console.error('Auto-save failed:', error);
        }
    }

    async function submitExam() {
        collectAnswers();
        
        try {
            const response = await fetch(`/api/exams/${examId}/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ answers })
            });
            
            if (response.ok) {
                clearInterval(timerInterval);
                showToast('Exam submitted successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard/student';
                }, 2000);
            } else {
                const error = await response.json();
                showToast(error.error || 'Failed to submit exam', 'error');
            }
        } catch (error) {
            console.error('Submit error:', error);
            showToast('Network error. Please try again.', 'error');
        }
    }

    function autoSubmitExam() {
        showToast('Time is up! Submitting exam automatically...', 'warning');
        setTimeout(submitExam, 2000);
    }

    // Event listeners
    prevButton.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    });

    nextButton.addEventListener('click', () => {
        if (currentQuestionIndex < examData.questions.length - 1) {
            showQuestion(currentQuestionIndex + 1);
        }
    });

    submitButton.addEventListener('click', () => {
        collectAnswers();
        const answeredCount = Object.keys(answers).length;
        document.getElementById('answeredCount').textContent = answeredCount;
        document.getElementById('totalQuestions').textContent = examData.questions.length;
        submitModal.classList.remove('hidden');
    });

    confirmSubmit.addEventListener('click', () => {
        submitModal.classList.add('hidden');
        submitExam();
    });

    cancelSubmit.addEventListener('click', () => {
        submitModal.classList.add('hidden');
    });

    // Collect answers when radio buttons change
    document.addEventListener('change', (e) => {
        if (e.target.type === 'radio') {
            collectAnswers();
            updateQuestionNumbers();
        }
    });

    // Prevent accidental page refresh
    window.addEventListener('beforeunload', (e) => {
        if (examData && timeRemaining > 0) {
            e.preventDefault();
            e.returnValue = 'Are you sure you want to leave? Your exam progress will be lost.';
        }
    });

    // Disable right-click and other shortcuts during exam
    document.addEventListener('contextmenu', (e) => e.preventDefault());
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 's' || e.key === 'S' || e.key === 'a' || e.key === 'A')) {
            e.preventDefault();
        }
        if (e.key === 'F12') {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}