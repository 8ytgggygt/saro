<!-- Student Monthly Exams - Read Only View -->
<div class="bg-white shadow-lg rounded-lg p-6">
    <!-- Exam List View -->
    <div id="examListView">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">üìä My Monthly Exams & Results</h2>
            <p class="text-gray-600">View your monthly exam results and rankings (Read-Only)</p>
        </div>

        <div id="examsLoading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading exams...</p>
        </div>

        <div id="noBatchMessage" class="hidden text-center py-12 bg-yellow-50 rounded-lg border border-yellow-200">
            <svg class="w-16 h-16 mx-auto mb-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <p class="text-gray-700 font-medium">You are not enrolled in any batch</p>
            <p class="text-gray-500 text-sm mt-2">Please contact your teacher to be added to a batch</p>
        </div>

        <div id="examsContainer" class="hidden space-y-4"></div>
    </div>

    <!-- Exam Details View -->
    <div id="examDetailsView" class="hidden">
        <button onclick="studentMonthlyExams.backToList()" class="mb-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
            <i class="fas fa-arrow-left mr-2"></i>Back to Exams
        </button>
        <div id="examDetailsContent"></div>
    </div>
</div>

<script>
// Student Monthly Exams Module v2.0.1 - Build: 2025-10-22-19:30
console.log('üìä Monthly Exams Module Loading v2.0.1');

(function() {
    var studentMonthlyExams = {
        currentUser: null,
        userBatchId: null,
        currentStudentId: null,
        
        init: function() {
            console.log('studentMonthlyExams.init() called');
            this.currentUser = {{ user|tojson if user else 'null' }};
            if (this.currentUser && this.currentUser.id) {
                this.currentStudentId = this.currentUser.id;
                console.log('Current student ID:', this.currentStudentId);
            }
            console.log('Loading user batches...');
            this.loadUserBatches();
        },
        
        loadUserBatches: function() {
            var self = this;
            console.log('========================================');
            console.log('üìö LOADING USER BATCHES');
            console.log('========================================');
            console.log('Fetching user batches from /api/students/me/batches');
            fetch('/api/students/me/batches')
                .then(function(response) {
                    console.log('Batches response status:', response.status);
                    if (!response.ok) {
                        console.error('‚ùå Batches request failed with status:', response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('üì¶ RAW Batches response:', JSON.stringify(data, null, 2));
                    
                    if (data.success && data.data && data.data.batches && data.data.batches.length > 0) {
                        console.log('‚úÖ Found', data.data.batches.length, 'batch(es)');
                        self.userBatchId = data.data.batches[0].id;
                        console.log('‚úÖ Using batch ID:', self.userBatchId, '- Batch name:', data.data.batches[0].name);
                        self.loadMonthlyExams();
                    } else {
                        console.log('‚ùå No batches found for user');
                        console.log('   data.success:', data.success);
                        console.log('   data.data:', data.data);
                        console.log('   data.data.batches:', data.data ? data.data.batches : 'N/A');
                        document.getElementById('examsLoading').classList.add('hidden');
                        document.getElementById('noBatchMessage').classList.remove('hidden');
                    }
                    console.log('========================================');
                })
                .catch(function(error) {
                    console.error('========================================');
                    console.error('‚ùå ERROR loading batches:', error);
                    console.error('========================================');
                    document.getElementById('examsLoading').classList.add('hidden');
                    document.getElementById('noBatchMessage').classList.remove('hidden');
                });
        },
        
        loadMonthlyExams: function() {
            var self = this;
            console.log('========================================');
            console.log('üìä LOADING MONTHLY EXAMS');
            console.log('========================================');
            console.log('Current batch ID:', self.userBatchId);
            console.log('Fetching monthly exams from /api/monthly-exams/');
            fetch('/api/monthly-exams/')
                .then(function(response) {
                    console.log('Monthly exams response status:', response.status);
                    if (!response.ok) {
                        console.error('‚ùå Exams request failed with status:', response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('üì¶ RAW Monthly exams response:', JSON.stringify(data, null, 2));
                    
                    if (data.success && data.data) {
                        // API returns data.data as the array of exams directly
                        var myExams = Array.isArray(data.data) ? data.data : [];
                        console.log('‚úÖ API returned', myExams.length, 'total exams');
                        
                        // Log each exam
                        myExams.forEach(function(exam, index) {
                            console.log('  Exam', index + 1 + ':', exam.title, '- Batch ID:', exam.batch_id, '- Batch Name:', exam.batch_name);
                        });
                        
                        // Filter by batch if needed (API already filters for students)
                        if (self.userBatchId && myExams.length > 0) {
                            var beforeFilter = myExams.length;
                            myExams = myExams.filter(function(exam) {
                                return exam.batch_id === self.userBatchId;
                            });
                            console.log('üîç Filtered from', beforeFilter, 'to', myExams.length, 'exams for batch ID', self.userBatchId);
                        }
                        
                        console.log('‚úÖ Final exam count to display:', myExams.length);
                        self.renderExams(myExams);
                    } else {
                        console.log('‚ùå No exams data in response');
                        console.log('   data.success:', data.success);
                        console.log('   data.data:', data.data);
                        self.renderExams([]);
                    }
                    document.getElementById('examsLoading').classList.add('hidden');
                    document.getElementById('examsContainer').classList.remove('hidden');
                    console.log('========================================');
                })
                .catch(function(error) {
                    console.error('========================================');
                    console.error('‚ùå ERROR loading exams:', error);
                    console.error('========================================');
                    document.getElementById('examsLoading').classList.add('hidden');
                    document.getElementById('examsContainer').classList.remove('hidden');
                });
        },
        
        renderExams: function(exams) {
            var container = document.getElementById('examsContainer');
            container.classList.remove('hidden');
            
            if (exams.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">' +
                    '<i class="fas fa-inbox text-4xl mb-3"></i>' +
                    '<p class="font-medium">No exams found for your batch</p>' +
                    '<p class="text-sm mt-2">Your teacher hasn\'t created any monthly exams yet</p>' +
                    '</div>';
                return;
            }
            
            console.log('Rendering', exams.length, 'exams');
            var html = '';
            for (var i = 0; i < exams.length; i++) {
                var exam = exams[i];
                html += '<div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">';
                html += '<div class="flex justify-between items-start">';
                html += '<div>';
                html += '<h3 class="text-lg font-semibold text-gray-900">' + exam.title + '</h3>';
                html += '<p class="text-sm text-gray-600 mt-1"><i class="fas fa-calendar mr-1"></i>' + exam.month_name + ' ' + exam.year + '</p>';
                html += '<p class="text-sm text-gray-600"><i class="fas fa-users mr-1"></i>' + exam.batch_name + '</p>';
                html += '</div>';
                html += '<button onclick="studentMonthlyExams.viewExamDetails(' + exam.id + ')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">';
                html += '<i class="fas fa-eye mr-2"></i>View Results';
                html += '</button>';
                html += '</div>';
                html += '</div>';
            }
            container.innerHTML = html;
            console.log('Exams rendered successfully');
        },
        
        viewExamDetails: function(examId) {
            var self = this;
            document.getElementById('examListView').classList.add('hidden');
            document.getElementById('examDetailsView').classList.remove('hidden');
            
            var detailsContent = document.getElementById('examDetailsContent');
            detailsContent.innerHTML = '<div class="text-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div><p class="text-gray-600">Loading exam details...</p></div>';
            
            fetch('/api/monthly-exams/' + examId + '/comprehensive-ranking')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && data.data) {
                        self.renderExamDetails(data.data);
                    } else {
                        detailsContent.innerHTML = '<div class="text-center py-8 text-red-500"><p>Error loading exam details</p></div>';
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    detailsContent.innerHTML = '<div class="text-center py-8 text-red-500"><p>Error loading exam details</p></div>';
                });
        },
        
        renderExamDetails: function(data) {
            var exam = data.exam;
            var rankings = data.rankings || [];
            var individualExams = data.individual_exams || [];
            
            var myRank = rankings.find(function(r) { return r.student_id === studentMonthlyExams.currentStudentId; });
            
            var html = '<div class="space-y-6">';
            
            // Exam Header
            html += '<div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-6 text-white">';
            html += '<h2 class="text-2xl font-bold mb-2">' + exam.title + '</h2>';
            html += '<p class="text-indigo-100"><i class="fas fa-calendar mr-2"></i>' + exam.month + '/' + exam.year + '</p>';
            html += '<p class="text-indigo-100"><i class="fas fa-users mr-2"></i>' + exam.batch_name + '</p>';
            html += '</div>';
            
            // My Performance Card
            if (myRank) {
                html += '<div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300 rounded-lg p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-user-circle mr-2 text-green-600"></i>My Performance</h3>';
                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
                html += '<div class="text-center">';
                html += '<p class="text-3xl font-bold text-indigo-600">' + myRank.rank + '</p>';
                html += '<p class="text-sm text-gray-600">Rank</p>';
                html += '</div>';
                html += '<div class="text-center">';
                html += '<p class="text-3xl font-bold text-green-600">' + myRank.percentage.toFixed(1) + '%</p>';
                html += '<p class="text-sm text-gray-600">Score</p>';
                html += '</div>';
                html += '<div class="text-center">';
                html += '<p class="text-3xl font-bold text-blue-600">' + myRank.total_marks + '/' + myRank.total_possible + '</p>';
                html += '<p class="text-sm text-gray-600">Total Marks</p>';
                html += '</div>';
                html += '<div class="text-center">';
                html += '<p class="text-3xl font-bold text-purple-600">' + myRank.attendance + '</p>';
                html += '<p class="text-sm text-gray-600">Attendance</p>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }
            
            // Rankings Table
            html += '<div class="bg-white rounded-lg border border-gray-200">';
            html += '<div class="p-4 border-b border-gray-200">';
            html += '<h3 class="text-lg font-bold text-gray-800"><i class="fas fa-trophy mr-2 text-yellow-500"></i>Class Rankings</h3>';
            html += '</div>';
            html += '<div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">';
            html += '<table class="min-w-full" style="width: max-content;">';
            html += '<thead class="bg-gray-50 sticky top-0">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rank</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Roll</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Student Name</th>';
            
            for (var i = 0; i < individualExams.length; i++) {
                html += '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">' + individualExams[i].subject_name + '</th>';
            }
            
            html += '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Total</th>';
            html += '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Percentage</th>';
            html += '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Grade</th>';
            html += '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Attendance</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody class="bg-white divide-y divide-gray-200">';
            
            for (var i = 0; i < rankings.length; i++) {
                var student = rankings[i];
                var isMe = student.student_id === studentMonthlyExams.currentStudentId;
                var rowClass = isMe ? 'bg-green-50 font-semibold' : '';
                var medalEmoji = student.rank === 1 ? 'ü•á' : (student.rank === 2 ? 'ü•à' : (student.rank === 3 ? 'ü•â' : ''));
                
                html += '<tr class="' + rowClass + '">';
                html += '<td class="px-4 py-3 text-center">' + medalEmoji + ' ' + student.rank + '</td>';
                html += '<td class="px-4 py-3">' + (student.roll_number || 'N/A') + '</td>';
                html += '<td class="px-4 py-3">' + student.student_name + (isMe ? ' <span class="text-green-600">(You)</span>' : '') + '</td>';
                
                for (var j = 0; j < individualExams.length; j++) {
                    var examId = individualExams[j].id;
                    var mark = student.individual_marks[examId];
                    if (mark !== undefined && mark !== null) {
                        html += '<td class="px-4 py-3 text-center">' + mark + '</td>';
                    } else {
                        html += '<td class="px-4 py-3 text-center text-gray-400">-</td>';
                    }
                }
                
                html += '<td class="px-4 py-3 text-center font-semibold">' + student.total_marks + '/' + student.total_possible + '</td>';
                html += '<td class="px-4 py-3 text-center font-semibold">' + student.percentage.toFixed(1) + '%</td>';
                html += '<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded text-xs font-semibold ' + studentMonthlyExams.getGradeColor(student.grade) + '">' + student.grade + '</span></td>';
                html += '<td class="px-4 py-3 text-center">' + student.attendance + '</td>';
                html += '</tr>';
            }
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('examDetailsContent').innerHTML = html;
        },
        
        getGradeColor: function(grade) {
            var colors = {
                'A+': 'bg-green-100 text-green-800',
                'A': 'bg-green-100 text-green-800',
                'A-': 'bg-green-100 text-green-800',
                'B': 'bg-blue-100 text-blue-800',
                'C': 'bg-yellow-100 text-yellow-800',
                'D': 'bg-orange-100 text-orange-800',
                'F': 'bg-red-100 text-red-800'
            };
            return colors[grade] || 'bg-gray-100 text-gray-800';
        },
        
        backToList: function() {
            document.getElementById('examDetailsView').classList.add('hidden');
            document.getElementById('examListView').classList.remove('hidden');
        }
    };
    
    window.studentMonthlyExams = studentMonthlyExams;
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        var section = document.getElementById('monthly-examsSection');
        if (section && !section.classList.contains('hidden')) {
            console.log('Student Monthly Exams: Initializing on page load');
            studentMonthlyExams.init();
        }
    });
    
    // Watch for section visibility changes
    if (document.getElementById('monthly-examsSection')) {
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                var section = document.getElementById('monthly-examsSection');
                if (section && !section.classList.contains('hidden') && !studentMonthlyExams.currentUser) {
                    console.log('Student Monthly Exams: Section became visible, initializing...');
                    studentMonthlyExams.init();
                    observer.disconnect();
                }
            });
        });
        
        observer.observe(document.body, { attributes: true, subtree: true, attributeFilter: ['class'] });
    }
})();
</script>
